<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <title>MetaFilter activity stats</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="data.js"></script>
    <style>
        html,
        body {
            font-family: system-ui;
            padding: 0;
            margin: 0;
        }

        header {
            position: sticky;
            top: 0;
            padding: 4px 10px;
            background-color: rgb(6, 90, 143);
            color: white;
            font-weight: 600;
            user-select: none;
        }

        header h1 {
            margin: 0 0 10px 0;
            font-size: x-large;
        }

        .fade {
            color: rgb(136, 194, 216);
        }

        .sub {
            font-weight: 600;
        }

        .green {
            color: rgb(156, 199, 84);
        }

        header p {
            margin: 6px 0;
        }

        select,
        option {
            font-size: large;
        }

        main {
            padding: 0 10px;
        }

        h2 {
            color: rgb(6, 90, 143);
            scroll-margin-top: 110px;
            margin: 8px 0 4px 0;
        }

        ul {
            margin-left: 0;
            padding-left: 20px;
        }
    </style>
</head>

<body>
    <header>
        <h1>
            me<span class="green">fi</span><span class="fade">st.at</span> <span class="sub">MetaFilter activity
                stats</span>
        </h1>
        <p>
            Filter:
            <select id="site">
                <option value="all" selected>All sites</option>
                <option value="mefi">MetaFilter</option>
                <option value="askme">AskMe</option>
                <option value="meta">MetaTalk</option>
                <option value="fanfare">Fanfare</option>
                <option value="music">Music</option>
            </select>
            <select id="minimumYear">
                <option value="0" selected>All time</option>
                <option value="2005">Since 2005</option>
                <option value="2010">Since 2010</option>
                <option value="2015">Since 2015</option>
                <option value="2020">Since 2020</option>
            </select>
        </p>
        <p>
            Go:
            <select id="go">
                <option value="#top" selected>Top</option>
                <option value="#users">Active users</option>
                <option value="#posts">Posts and comments</option>
                <option value="#posts_per_user">Per active user</option>
                <option value="#comments_per_post">Comments per post</option>
                <option value="#days">Day of week and hour</option>
            </select>
        </p>
    </header>
    <main>
        <ul>
            <li>
                <a href="https://stuff.metafilter.com/infodump/">Infodump</a> data from
                <strong id="timestamp">Loading</strong>. Infodump updates show here within 24 hours.
            </li>
            <li>
                Charts exclude the latest (incomplete) month.
            </li>
            <li>
                A user is "active" if they made at least one post or comment on the selected site(s) during the month.
            </li>
            <li>
                Any problems or comments, <a href="https://www.metafilter.com/user/304523">MeFi Mail me</a> or
                <a href="https://github.com/klipspringr/mefi-activity/issues">open an issue</a>.
                <a href="https://github.com/klipspringr/mefi-activity">Source on GitHub</a>. Not affiliated with
                MetaFilter LLC.
            </li>
        </ul>

        <h2 id="users">Active users</h2>
        <canvas id="chart_users"></canvas>

        <h2 id="users_years">Active users: by year joined</h2>
        <canvas id="chart_users_years"></canvas>

        <h2 id="users_cumulative">Active users: new and cumulative</h2>
        <canvas id="chart_users_cumulative"></canvas>

        <h2 id="posts">Posts</h2>
        <canvas id="chart_posts"></canvas>

        <h2 id="comments">Comments</h2>
        <canvas id="chart_comments"></canvas>

        <h2 id="activity_by_age">Posts and comments by age of user account</h2>
        <canvas id="chart_activity_by_age"></canvas>
        <p>
            User account age at time of posting or commenting. Initially the database did not record join date; the
            first ~200 users are assumed to have joined on 27 January 2000.
        </p>

        <h2 id="posts_per_user">Posts: per active user</h2>
        <canvas id="chart_posts_per_user"></canvas>

        <h2 id="comments_per_user">Comments: per active user</h2>
        <canvas id="chart_comments_per_user"></canvas>

        <h2 id="comments_per_post">Comments: per post</h2>
        <canvas id="chart_comments_per_post"></canvas>

        <h2 id="days">Posts and comments: by day of week</h2>
        <canvas id="chart_days"></canvas>

        <h2 id="hours">Posts and comments: by hour</h2>
        <canvas id="chart_hours"></canvas>
        <p>Timestamps are recorded on the MetaFilter server in Pacific Time.</p>
    </main>

    <script>
        "use strict"
        const CHARTS = {}
        let site

        Chart.defaults.animation = false
        Chart.defaults.parsing = false

        Chart.defaults.scales.linear.beginAtZero = true
        Chart.defaults.scales.timeseries.grid = { display: false }
        Chart.defaults.scales.timeseries.ticks.callback = (v, i, t) => {
            const d = new Date(v)
            return d.getMonth() == 6 ? d.getFullYear() : undefined
        }
        Chart.defaults.scales.timeseries.time.tooltipFormat = "MMMM yyyy"

        Chart.defaults.datasets.line.pointStyle = false
        Chart.defaults.datasets.bar.barPercentage = 1
        Chart.defaults.datasets.bar.categoryPercentage = 1

        Chart.defaults.plugins.legend.display = false
        Chart.defaults.plugins.legend.position = "bottom"

        const NUM_FORMAT = Intl.NumberFormat()
        const AGE_LABELS = { 0: "< 1 year", 1: "1-5 years", 5: "5-10 years", 10: "10-15 years", 15: ">15 years" }

        const chartInit = (id, config) => CHARTS[id] = new Chart(document.getElementById("chart_" + id), config)
        const tooltipTotalUsers = (ctx) => "Total active users: " + NUM_FORMAT.format(MONTHLY[site].users_total[ctx[0].dataIndex])
        const tooltipPerDay = (ctx) => "Per day: " + NUM_FORMAT.format(Math.round(ctx[0].parsed.y / (365 / 12)))

        chartInit("users", {
            type: 'bar',
            options: {
                scales: {
                    y: {
                        stacked: true
                    },
                    x: {
                        stacked: true,
                        type: "timeseries",
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterTitle: tooltipTotalUsers
                        }
                    },
                },
            },
        })
        chartInit("users_years", {
            type: 'bar',
            options: {
                scales: {
                    y: {
                        stacked: true,
                        max: 1,
                        ticks: {
                            format: {
                                style: "percent",
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 1
                            }
                        }
                    },
                    x: {
                        stacked: true,
                        type: "timeseries",
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterTitle: tooltipTotalUsers,
                        }
                    },
                }
            },
        })
        chartInit("users_cumulative", {
            data: {
                datasets: [
                    {
                        type: "bar",
                        label: "Users first active (LHS)",
                        yAxisID: 'y_left',
                        order: 1
                    },
                    {
                        type: "line",
                        label: "Users ever active (RHS)",
                        yAxisID: 'y_right',
                    }
                ],
            },
            options: {
                scales: {
                    y_left: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                    },
                    y_right: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    x: {
                        type: "timeseries",
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                },
            },
        })
        chartInit("posts", {
            type: 'bar',
            data: {
                datasets: [{
                    backgroundColor: 'rgb(255, 99, 132)',
                }]
            },
            options: {
                scales: {
                    x: {
                        type: "timeseries",
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            footer: tooltipPerDay
                        }
                    },
                }
            },
        })
        chartInit("comments", {
            type: 'bar',
            data: {
                datasets: [{
                    backgroundColor: 'rgb(153, 102, 255)',
                }]
            },
            options: {
                scales: {
                    x: {
                        type: "timeseries",
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            footer: tooltipPerDay
                        }
                    },
                }
            },
        })
        chartInit("activity_by_age", {
            type: 'bar',
            options: {
                scales: {
                    y: {
                        stacked: true,
                        max: 1,
                        ticks: {
                            format: {
                                style: "percent",
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 1
                            }
                        }
                    },
                    x: {
                        stacked: true,
                        type: "timeseries",
                    }
                },
                interaction: {
                    mode: "index"
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            },
        })

        chartInit("posts_per_user", {
            type: 'line',
            data: {
                datasets: [{
                    borderColor: 'rgb(255, 99, 132)',
                }]
            },
            options: {
                scales: {
                    x: {
                        type: "timeseries",
                    }
                },
            }
        })
        chartInit("comments_per_user", {
            type: 'line',
            data: {
                datasets: [{
                    borderColor: 'rgb(153, 102, 255)',
                }]
            },
            options: {
                scales: {
                    x: {
                        type: "timeseries",
                    }
                },
            }
        })
        chartInit("comments_per_post", {
            type: 'line',
            data: {
                datasets: [{
                    borderColor: 'rgb(153, 102, 255)',
                }]
            },
            options: {
                scales: {
                    x: {
                        type: "timeseries",
                    }
                },
            }
        })
        chartInit("days", {
            type: 'bar',
            data: {
                labels: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
                datasets: [{
                    label: "Posts",
                    backgroundColor: 'rgb(255, 99, 132)',
                },
                {
                    label: "Comments",
                    backgroundColor: 'rgb(153, 102, 255)',
                }]
            },
            options: {
                parsing: true,
                datasets: {
                    bar: {
                        categoryPercentage: 0.8,
                        barPercentage: 0.9
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            format: {
                                style: "percent",
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 1
                            }
                        }
                    }
                },
                interaction: {
                    mode: "index"
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            },
        })
        chartInit("hours", {
            type: 'bar',
            data: {
                labels: [...Array(24).keys()],
                datasets: [{
                    label: "Posts",
                    backgroundColor: 'rgb(255, 99, 132)',
                },
                {
                    label: "Comments",
                    backgroundColor: 'rgb(153, 102, 255)',
                }]
            },
            options: {
                parsing: true,
                datasets: {
                    bar: {
                        categoryPercentage: 0.8,
                        barPercentage: 0.9
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            format: {
                                style: "percent",
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 1
                            }
                        }
                    }
                },
                interaction: {
                    mode: "index"
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            },
        })

        const applyMinimumYear = (minYear) => {
            for (const c of ["users", "users_years", "users_cumulative", "posts", "comments", "activity_by_age", "posts_per_user", "comments_per_user", "comments_per_post"]) {
                CHARTS[c].options.scales.x.min = minYear > 0 ? new Date(minYear, 0, 1).getTime() : undefined
                CHARTS[c].update()
            }
        }

        const applyMonthlyData = (chartId, datasetIndex, datasetSource, labelSource, datasetLabel = undefined) => {
            if (datasetIndex === CHARTS[chartId].data.datasets.length) {
                CHARTS[chartId].data.datasets.push({})
            }
            CHARTS[chartId].data.datasets[datasetIndex].data = datasetSource.map((v, i) => ({
                x: labelSource[i],
                y: v
            }))
            if (datasetLabel) {
                CHARTS[chartId].data.datasets[datasetIndex].label = datasetLabel
            }
        }

        const updateCharts = () => {
            const months = Array(MONTHLY[site].users_total.length).fill(0).map((_, i) =>
                (new Date(MONTHLY[site].epoch_year, MONTHLY[site].epoch_month + i - 1, 1)).getTime())

            // set chart data
            CHARTS["users"].data.datasets = []
            CHARTS["users_years"].data.datasets = []
            Object.entries(MONTHLY[site].users_by_year).forEach(([year, counts], i) => {
                applyMonthlyData("users", i, counts, months, "Joined " + year)
                applyMonthlyData("users_years", i, counts.map((v, i) => (v / MONTHLY[site].users_total[i])), months, "Joined " + year)
            })

            applyMonthlyData("users_cumulative", 0, MONTHLY[site].users_new, months)
            applyMonthlyData("users_cumulative", 1, MONTHLY[site].users_cumulative, months)

            CHARTS["activity_by_age"].data.datasets = []
            Object.entries(MONTHLY[site].activity_by_age).forEach(([cutoff, counts], i) => {
                applyMonthlyData("activity_by_age", i, counts, months, AGE_LABELS[cutoff])
            })

            applyMonthlyData("posts", 0, MONTHLY[site].posts, months)
            applyMonthlyData("comments", 0, MONTHLY[site].comments, months)
            applyMonthlyData("posts_per_user", 0, MONTHLY[site].posts.map((v, i) => (v / MONTHLY[site].users_total[i])), months)
            applyMonthlyData("comments_per_user", 0, MONTHLY[site].comments.map((v, i) => (v / MONTHLY[site].users_total[i])), months)
            applyMonthlyData("comments_per_post", 0, MONTHLY[site].comments.map((v, i) => (v / MONTHLY[site].posts[i])), months)

            // mefi posts per user is very high in early years, so truncate y-axis at 2
            CHARTS["posts_per_user"].options.scales.y.max = (site === "all" || site === "mefi") ? 2 : undefined

            CHARTS["days"].data.datasets[0].data = DAILY[site].posts
            CHARTS["days"].data.datasets[1].data = DAILY[site].comments
            CHARTS["hours"].data.datasets[0].data = HOURLY[site].posts
            CHARTS["hours"].data.datasets[1].data = HOURLY[site].comments

            Object.values(CHARTS).forEach(c => c.update())
        }

        document.getElementById("timestamp").innerText = TIMESTAMP
        document.getElementById("site").addEventListener("change", (e) => {
            site = e.target.value
            updateCharts()
        })
        document.getElementById("minimumYear").addEventListener("change", (e) =>
            applyMinimumYear(parseInt(e.target.value)))

        location.hash && (document.getElementById("go").value = location.hash)
        document.getElementById("go").addEventListener("change", (e) => location.hash = e.target.value)

        site = document.getElementById("site").value
        updateCharts()
    </script>
</body>

</html>