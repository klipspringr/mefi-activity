<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <title>MetaFilter activity stats</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        body {
            font-family: system-ui;
        }

        select,
        option {
            font-size: large;
        }
    </style>
</head>

<body>
    <h1>MetaFilter activity stats</h1>

    <h3>
        Show data for:
        <select id="site">
            <option value="all" selected>All sites</option>
            <option value="mefi">MetaFilter</option>
            <option value="askme">AskMe</option>
            <option value="meta">MetaTalk</option>
            <option value="fanfare">Fanfare</option>
            <option value="music">Music</option>
        </select>
    </h3>

    <ul>
        <li>
            <a href="https://stuff.metafilter.com/infodump/">Infodump</a> data from <strong
                id="infodump_timestamp">Loading...</strong>. Infodump updates show here within 24 hours.
        </li>
        <li>
            Any problems or comments, open an issue on <a href="https://github.com/klipspringr/mefi-activity">github</a>
            or <a href="https://www.metafilter.com/user/304523">MeFi Mail</a> me.
        </li>
        <li>
            A user is "active" if they made at least one post or comment on the selected subsite during the month.
            Active users are broken down by year joined.
        </li>
        <li>
            Charts exclude the latest (incomplete) month.
        </li>
    </ul>

    <h2>Monthly active users</h2>
    <canvas id="chart_active"></canvas>

    <h2>Posts per month</h2>
    <canvas id="chart_posts"></canvas>

    <h2>Comments per month</h2>
    <canvas id="chart_comments"></canvas>

    <h2>Posts per month per active user</h2>
    <canvas id="chart_posts_per_user"></canvas>

    <h2>Comments per month per active user</h2>
    <canvas id="chart_comments_per_user"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
        let json
        let site

        let chartActive = new Chart(document.getElementById('chart_active'), {
            type: 'bar',
            data: {},
            options: {
                datasets: {
                    bar: {
                        barPercentage: 1,
                        categoryPercentage: 1
                    }
                },
                scales: {
                    y: {
                        stacked: true
                    },
                    x: {
                        stacked: true
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            footer: (ctx) => "Total active: " + Intl.NumberFormat().format(json["active"][site]["totals"][ctx[0].dataIndex])
                        }
                    },
                    legend: {
                        display: false,
                    }
                }
            },

        })
        let chartPosts = new Chart(document.getElementById('chart_posts'), {
            type: 'bar',
            data: {
                datasets: [{
                    label: 'Posts per month',
                    data: [],
                    backgroundColor: 'rgb(255, 99, 132)',
                    barPercentage: 1,
                    categoryPercentage: 1
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                        callbacks: {
                            footer: (ctx) => "Posts per day: " + Intl.NumberFormat().format(Math.round(ctx[0].parsed.y / (365 / 12)))
                        }
                    },
                    legend: {
                        display: false,
                    }
                }
            },
        })
        let chartComments = new Chart(document.getElementById('chart_comments'), {
            type: 'bar',
            data: {
                datasets: [{
                    label: 'Comments per month',
                    data: [],
                    backgroundColor: 'rgb(153, 102, 255)',
                    barPercentage: 1,
                    categoryPercentage: 1
                }]
            },
            options: {
                plugins: {
                    tooltip: {
                        callbacks: {
                            footer: (ctx) => "Comments per day: " + Intl.NumberFormat().format(Math.round(ctx[0].parsed.y / (365 / 12)))
                        }
                    },
                    legend: {
                        display: false,
                    }
                }
            },
        })
        let chartPostsPerUser = new Chart(document.getElementById('chart_posts_per_user'), {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Posts per active user',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                }]
            },
            options: {
                plugins: {
                    legend: {
                        display: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                    }
                }
            }
        })
        let chartCommentsPerUser = new Chart(document.getElementById('chart_comments_per_user'), {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Comments per active user',
                    data: [],
                    borderColor: 'rgb(153, 102, 255)',
                }]
            },
            options: {
                plugins: {
                    legend: {
                        display: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                    }
                }
            },
        })

        function updateCharts() {
            site = document.getElementById("site").value

            chartActive.data.labels = json["active"][site]["labels"]
            chartActive.data.datasets = Object.entries(json["active"][site]["by_year"]).map(([year, counts]) => ({ label: "Joined " + year, data: counts }))

            chartPosts.data.labels = Object.keys(json["posts"][site])
            chartPosts.data.datasets[0].data = Object.values(json["posts"][site])

            chartComments.data.labels = Object.keys(json["comments"][site])
            chartComments.data.datasets[0].data = Object.values(json["comments"][site])

            chartPostsPerUser.data.labels = Object.keys(json["posts"][site])
            chartPostsPerUser.data.datasets[0].data = Object.values(json["posts"][site]).map((v, i) => (v / json["active"][site]["totals"][i]))

            // for all and mefi, posts per user was distortingly high in early years, so truncate y-axis at 2
            chartPostsPerUser.options.scales.y.max = (site === "all" || site === "mefi") ? 2 : undefined

            chartCommentsPerUser.data.labels = Object.keys(json["comments"][site])
            chartCommentsPerUser.data.datasets[0].data = Object.values(json["comments"][site]).map((v, i) => (v / json["active"][site]["totals"][i]))

            chartActive.update()
            chartPosts.update()
            chartComments.update()
            chartPostsPerUser.update()
            chartCommentsPerUser.update()
        }

        fetch("data.json", { cache: "no-store" }).then(r => {
            if (!r.ok) throw new Error("HTTP error " + r.status)
            return r.json()
        }).then(j => {
            json = j
            document.getElementById("infodump_timestamp").innerText = json["infodump_timestamp"]
            document.getElementById("site").addEventListener("change", (e) => updateCharts())
            updateCharts()
        })
    </script>
</body>

</html>