<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <title>MetaFilter activity stats</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="data.js"></script>
    <style>
        html,
        body {
            font-family: system-ui;
            padding: 0;
            margin: 0;
        }

        header {
            position: sticky;
            top: 0;
            padding: 10px;
            background-color: rgb(6, 90, 143);
            font-weight: 600;
            color: #FFFFFF;
        }

        header h1 {
            font-size: x-large;
            color: rgb(136, 194, 216);
            margin: 0 0 10px 0;
        }

        select,
        option {
            font-size: large;
            max-width: 10rem;
        }

        main {
            padding: 0 10px;
        }

        h2 {
            color: rgb(6, 90, 143);
            scroll-margin-top: 90px;
            margin: 8px 0 4px 0;
        }

        .white {
            color: white;
        }

        .green {
            color: rgb(156, 199, 84);
        }
    </style>
</head>

<body>
    <header>
        <h1><span class="white">Meta</span><span class="green">Filter</span> activity stats</h1>
        <label>Site:
            <select id="siteSelector">
                <option value="all" selected>All sites</option>
                <option value="mefi">MetaFilter</option>
                <option value="askme">AskMe</option>
                <option value="meta">MetaTalk</option>
                <option value="fanfare">Fanfare</option>
                <option value="music">Music</option>
            </select>
        </label>
        &middot;
        <label>Go:
            <select id="jumpSelector">
                <option value="#top" selected>Top</option>
                <option value="#users">Active users</option>
                <option value="#posts">Posts and comments</option>
                <option value="#posts_per_user">Per active user</option>
                <option value="#comments_per_post">Comments per post</option>
                <option value="#days">Day of week and hour</option>
            </select>
        </label>
    </header>
    <main>
        <ul>
            <li>
                <a href="https://stuff.metafilter.com/infodump/">Infodump</a> data from
                <strong id="timestamp">Loading</strong>. Infodump updates show here within 24 hours.
            </li>
            <li>
                Charts exclude the latest (incomplete) month.
            </li>
            <li>
                A user is "active" if they made at least one post or comment on the selected subsite during the month.
                Active users are broken down by year joined.
            </li>
            <li>
                Any problems or comments, <a href="https://www.metafilter.com/user/304523">MeFi Mail me</a> or
                <a href="https://github.com/klipspringr/mefi-activity/issues">open an issue</a>.
                <a href="https://github.com/klipspringr/mefi-activity">Source on GitHub</a>. Not affiliated with
                MetaFilter LLC.
            </li>
        </ul>

        <h2 id="users">Active users</h2>
        <canvas id="chart_users"></canvas>

        <h2 id="users_years">Active users: by year joined</h2>
        <canvas id="chart_users_years"></canvas>

        <h2 id="users_cumulative">Active users: new and cumulative</h2>
        <canvas id="chart_users_cumulative"></canvas>

        <h2 id="posts">Posts</h2>
        <canvas id="chart_posts"></canvas>

        <h2 id="comments">Comments</h2>
        <canvas id="chart_comments"></canvas>

        <h2 id="posts_per_user">Posts: per active user</h2>
        <canvas id="chart_posts_per_user"></canvas>

        <h2 id="comments_per_user">Comments: per active user</h2>
        <canvas id="chart_comments_per_user"></canvas>

        <h2 id="comments_per_post">Comments: per post</h2>
        <canvas id="chart_comments_per_post"></canvas>

        <h2 id="days">Posts and comments: by day of week</h2>
        <canvas id="chart_days"></canvas>

        <h2 id="hours">Posts and comments: by hour</h2>
        <canvas id="chart_hours"></canvas>
        <p>Timestamps are recorded on the MetaFilter server in Pacific Time.</p>
    </main>

    <script>
        "use strict"
        const charts = {}
        let site

        Chart.defaults.plugins.legend.display = false
        Chart.defaults.scales.linear.beginAtZero = true

        const updateCharts = () => {
            site = document.getElementById("siteSelector").value

            // set labels for monthly charts
            for (const c of ["users", "users_years", "users_cumulative", "posts", "comments", "posts_per_user", "comments_per_user", "comments_per_post"]) {
                charts[c].data.labels = MONTHLY[site].labels
            }

            // set chart data
            charts["users"].data.datasets = Object.entries(MONTHLY[site].users_by_year).map(([year, counts]) => ({ label: "Joined " + year, data: counts }))
            charts["users_years"].data.datasets = Object.entries(MONTHLY[site].users_by_year).map(([year, counts]) =>
                ({ label: "Joined " + year, data: counts.map((v, i) => (v / MONTHLY[site].users_total[i])) }))
            charts["users_cumulative"].data.datasets[0].data = MONTHLY[site].users_cumulative
            charts["users_cumulative"].data.datasets[1].data = MONTHLY[site].users_new
            charts["posts"].data.datasets[0].data = MONTHLY[site].posts
            charts["comments"].data.datasets[0].data = MONTHLY[site].comments
            charts["posts_per_user"].data.datasets[0].data = MONTHLY[site].posts.map((v, i) => (v / MONTHLY[site].users_total[i]))
            charts["comments_per_user"].data.datasets[0].data = MONTHLY[site].comments.map((v, i) => (v / MONTHLY[site].users_total[i]))
            charts["comments_per_post"].data.datasets[0].data = MONTHLY[site].comments.map((v, i) => (v / MONTHLY[site].posts[i]))
            charts["days"].data.datasets[0].data = DAILY[site].posts
            charts["days"].data.datasets[1].data = DAILY[site].comments
            charts["hours"].data.datasets[0].data = HOURLY[site].posts
            charts["hours"].data.datasets[1].data = HOURLY[site].comments

            // mefi posts per user is very high in early years, so truncate y-axis at 2
            charts["posts_per_user"].options.scales.y.max = (site === "all" || site === "mefi") ? 2 : undefined

            Object.values(charts).forEach(c => c.update())
        }

        const chartInit = (id, config) => charts[id] = new Chart(document.getElementById("chart_" + id), config)
        const tooltipPerDay = (ctx) => "Per day: " + Intl.NumberFormat().format(Math.round(ctx[0].parsed.y / (365 / 12)))

        chartInit("users", {
            type: 'bar',
            options: {
                datasets: {
                    bar: {
                        barPercentage: 1,
                        categoryPercentage: 1
                    }
                },
                scales: {
                    y: {
                        stacked: true
                    },
                    x: {
                        stacked: true
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterTitle: (ctx) => "Total active users: " + Intl.NumberFormat().format(MONTHLY[site].users_total[ctx[0].dataIndex])
                        }
                    },
                }
            },
        })
        chartInit("users_years", {
            type: 'bar',
            options: {
                datasets: {
                    bar: {
                        barPercentage: 1,
                        categoryPercentage: 1
                    }
                },
                scales: {
                    y: {
                        stacked: true,
                        max: 1,
                        ticks: {
                            format: {
                                style: "percent",
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 1
                            }
                        }
                    },
                    x: {
                        stacked: true
                    }
                },
                animation: {
                    numbers: true
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterTitle: (ctx) => "Total active users: " + Intl.NumberFormat().format(MONTHLY[site].users_total[ctx[0].dataIndex]),
                        }
                    },
                }
            },
        })
        chartInit("users_cumulative", {
            data: {
                datasets: [{
                    type: "line",
                    label: "Users ever active (LHS)",
                    yAxisID: 'y_left',
                },
                {
                    type: "bar",
                    label: "Users first active (RHS)",
                    yAxisID: 'y_right',
                }],
            },
            options: {
                datasets: {
                    bar: {
                        barPercentage: 1,
                        categoryPercentage: 1
                    },
                    line: {
                        pointStyle: false
                    }
                },
                scales: {
                    y_left: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                    },
                    y_right: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                        },
                    },
                },
                plugins: {
                    legend: {
                        display: true
                    }
                },
            },
        })
        chartInit("posts", {
            type: 'bar',
            data: {
                datasets: [{
                    backgroundColor: 'rgb(255, 99, 132)',
                }]
            },
            options: {
                datasets: {
                    bar: {
                        barPercentage: 1,
                        categoryPercentage: 1
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            footer: tooltipPerDay
                        }
                    },
                }
            },
        })
        chartInit("comments", {
            type: 'bar',
            data: {
                datasets: [{
                    backgroundColor: 'rgb(153, 102, 255)',
                }]
            },
            options: {
                datasets: {
                    bar: {
                        barPercentage: 1,
                        categoryPercentage: 1
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            footer: tooltipPerDay
                        }
                    },
                }
            },
        })
        chartInit("posts_per_user", {
            type: 'line',
            data: {
                datasets: [{
                    borderColor: 'rgb(255, 99, 132)',
                }]
            },
        })
        chartInit("comments_per_user", {
            type: 'line',
            data: {
                datasets: [{
                    borderColor: 'rgb(153, 102, 255)',
                }]
            },
        })
        chartInit("comments_per_post", {
            type: 'line',
            data: {
                datasets: [{
                    borderColor: 'rgb(153, 102, 255)',
                }]
            },
        })
        chartInit("days", {
            type: 'bar',
            data: {
                labels: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
                datasets: [{
                    label: "Posts",
                    backgroundColor: 'rgb(255, 99, 132)',
                },
                {
                    label: "Comments",
                    backgroundColor: 'rgb(153, 102, 255)',
                }]
            },
            options: {
                scales: {
                    y: {
                        ticks: {
                            format: {
                                style: "percent",
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 1
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            },
        })
        chartInit("hours", {
            type: 'bar',
            data: {
                labels: [...Array(24).keys()],
                datasets: [{
                    label: "Posts",
                    backgroundColor: 'rgb(255, 99, 132)',
                },
                {
                    label: "Comments",
                    backgroundColor: 'rgb(153, 102, 255)',
                }]
            },
            options: {
                scales: {
                    y: {
                        ticks: {
                            format: {
                                style: "percent",
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 1
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            },
        })

        document.getElementById("timestamp").innerText = TIMESTAMP
        document.getElementById("siteSelector").addEventListener("change", updateCharts)
        location.hash && (document.getElementById("jumpSelector").value = location.hash)
        document.getElementById("jumpSelector").addEventListener("change", (e) => location.hash = e.target.value)
        updateCharts()
    </script>
</body>

</html>